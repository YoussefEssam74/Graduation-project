# ML Implementation Checklist - New Components Only

This checklist shows **only NEW files and tables** to add for the 5 ML models.

---

## Phase 1: Database Tables (New Migrations)

### New Tables to Create

```sql
-- Chat Messages (for AI Coach conversations)
CREATE TABLE ChatMessages (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    UserId UUID NOT NULL REFERENCES Users(Id),
    Message TEXT NOT NULL,
    Response TEXT NOT NULL,
    IsFromUser BOOLEAN NOT NULL,
    CreatedAt TIMESTAMP NOT NULL DEFAULT NOW(),
    Context JSONB -- Store conversation context
);

-- Equipment Usage Tracking (for Analytics)
CREATE TABLE EquipmentUsage (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    EquipmentId UUID NOT NULL REFERENCES Equipment(Id),
    UserId UUID NULL REFERENCES Users(Id),
    StartTime TIMESTAMP NOT NULL,
    EndTime TIMESTAMP NULL,
    DurationMinutes INT NULL,
    CaloriesBurned DECIMAL NULL,
    CreatedAt TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Workout Plans (generated by ML)
CREATE TABLE WorkoutPlans (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    UserId UUID NOT NULL REFERENCES Users(Id),
    Goal TEXT NOT NULL, -- 'strength', 'weight_loss', 'endurance'
    FitnessLevel TEXT NOT NULL, -- 'beginner', 'intermediate', 'advanced'
    Duration INT NOT NULL, -- weeks
    GeneratedPlan JSONB NOT NULL, -- Full plan from ML
    CreatedAt TIMESTAMP NOT NULL DEFAULT NOW(),
    IsActive BOOLEAN DEFAULT true
);

-- Nutrition Plans (generated by ML)
CREATE TABLE NutritionPlans (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    UserId UUID NOT NULL REFERENCES Users(Id),
    Goal TEXT NOT NULL, -- 'weight_loss', 'muscle_gain', 'maintenance'
    DailyCalories INT NOT NULL,
    Macros JSONB NOT NULL, -- {protein, carbs, fats}
    GeneratedPlan JSONB NOT NULL, -- Full meal plan from ML
    CreatedAt TIMESTAMP NOT NULL DEFAULT NOW(),
    IsActive BOOLEAN DEFAULT true
);

-- Scheduled Reminders (for Proactive Coach)
CREATE TABLE ProactiveReminders (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    UserId UUID NOT NULL REFERENCES Users(Id),
    ReminderType TEXT NOT NULL, -- 'workout', 'nutrition', 'hydration'
    Message TEXT NOT NULL,
    ScheduledTime TIMESTAMP NOT NULL,
    IsSent BOOLEAN DEFAULT false,
    CreatedAt TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Voice Transcriptions
CREATE TABLE VoiceTranscriptions (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    UserId UUID NOT NULL REFERENCES Users(Id),
    AudioFilePath TEXT NULL,
    TranscriptionText TEXT NOT NULL,
    Language TEXT DEFAULT 'en',
    CreatedAt TIMESTAMP NOT NULL DEFAULT NOW()
);
```

**Action**: Create EF Core migration:
```bash
cd Graduation-Project
dotnet ef migrations add AddMLTables
dotnet ef database update
```

---

## Phase 2: .NET Domain Layer (New Models)

### Core/DomainLayer/Models/ (NEW FILES)

#### ✅ WorkoutPlan.cs
```csharp
namespace DomainLayer.Models;

public class WorkoutPlan
{
    public Guid Id { get; set; }
    public Guid UserId { get; set; }
    public string Goal { get; set; } = string.Empty;
    public string FitnessLevel { get; set; } = string.Empty;
    public int Duration { get; set; }
    public string GeneratedPlan { get; set; } = string.Empty; // JSON
    public DateTime CreatedAt { get; set; }
    public bool IsActive { get; set; }
}
```

#### ✅ NutritionPlan.cs
```csharp
namespace DomainLayer.Models;

public class NutritionPlan
{
    public Guid Id { get; set; }
    public Guid UserId { get; set; }
    public string Goal { get; set; } = string.Empty;
    public int DailyCalories { get; set; }
    public string Macros { get; set; } = string.Empty; // JSON
    public string GeneratedPlan { get; set; } = string.Empty; // JSON
    public DateTime CreatedAt { get; set; }
    public bool IsActive { get; set; }
}
```

#### ✅ ChatMessage.cs
```csharp
namespace DomainLayer.Models;

public class ChatMessage
{
    public Guid Id { get; set; }
    public Guid UserId { get; set; }
    public string Message { get; set; } = string.Empty;
    public string Response { get; set; } = string.Empty;
    public bool IsFromUser { get; set; }
    public DateTime CreatedAt { get; set; }
    public string? Context { get; set; } // JSON
}
```

#### ✅ EquipmentUsage.cs
```csharp
namespace DomainLayer.Models;

public class EquipmentUsage
{
    public Guid Id { get; set; }
    public Guid EquipmentId { get; set; }
    public Guid? UserId { get; set; }
    public DateTime StartTime { get; set; }
    public DateTime? EndTime { get; set; }
    public int? DurationMinutes { get; set; }
    public decimal? CaloriesBurned { get; set; }
    public DateTime CreatedAt { get; set; }
}
```

#### ✅ ProactiveReminder.cs
```csharp
namespace DomainLayer.Models;

public class ProactiveReminder
{
    public Guid Id { get; set; }
    public Guid UserId { get; set; }
    public string ReminderType { get; set; } = string.Empty;
    public string Message { get; set; } = string.Empty;
    public DateTime ScheduledTime { get; set; }
    public bool IsSent { get; set; }
    public DateTime CreatedAt { get; set; }
}
```

#### ✅ VoiceTranscription.cs
```csharp
namespace DomainLayer.Models;

public class VoiceTranscription
{
    public Guid Id { get; set; }
    public Guid UserId { get; set; }
    public string? AudioFilePath { get; set; }
    public string TranscriptionText { get; set; } = string.Empty;
    public string Language { get; set; } = "en";
    public DateTime CreatedAt { get; set; }
}
```

---

## Phase 3: .NET Service Interfaces (New Contracts)

### Core/ServiceAbstraction/Services/ (NEW FILES)

#### ✅ IWorkoutService.cs
```csharp
using DomainLayer.Models;

namespace ServiceAbstraction.Services;

public interface IWorkoutService
{
    Task<WorkoutPlan> GenerateWorkoutPlanAsync(Guid userId, string goal, string fitnessLevel, int durationWeeks);
    Task<WorkoutPlan?> GetActiveWorkoutPlanAsync(Guid userId);
    Task<IEnumerable<WorkoutPlan>> GetUserWorkoutHistoryAsync(Guid userId);
}
```

#### ✅ INutritionService.cs
```csharp
using DomainLayer.Models;

namespace ServiceAbstraction.Services;

public interface INutritionService
{
    Task<NutritionPlan> GenerateNutritionPlanAsync(Guid userId, string goal, int dailyCalories);
    Task<NutritionPlan?> GetActiveNutritionPlanAsync(Guid userId);
}
```

#### ✅ ICoachService.cs
```csharp
using DomainLayer.Models;

namespace ServiceAbstraction.Services;

public interface ICoachService
{
    Task<ChatMessage> SendMessageAsync(Guid userId, string message);
    Task<IEnumerable<ChatMessage>> GetConversationHistoryAsync(Guid userId, int limit = 50);
    Task ScheduleReminderAsync(Guid userId, string reminderType, DateTime scheduledTime);
}
```

#### ✅ IAnalyticsService.cs
```csharp
namespace ServiceAbstraction.Services;

public interface IAnalyticsService
{
    Task<object> GetEquipmentUsageReportAsync(DateTime startDate, DateTime endDate);
    Task<object> ForecastRevenueAsync(int days = 30);
    Task<object> PredictMaintenanceAsync(Guid equipmentId);
}
```

#### ✅ IVoiceService.cs
```csharp
using DomainLayer.Models;

namespace ServiceAbstraction.Services;

public interface IVoiceService
{
    Task<VoiceTranscription> TranscribeAudioAsync(Guid userId, Stream audioStream, string language = "en");
    Task<byte[]> SynthesizeSpeechAsync(string text, string language = "en");
}
```

---

## Phase 4: .NET Service Implementations

### Core/Service/Services/ (NEW FILES)

#### ✅ WorkoutService.cs
```csharp
using DomainLayer.Models;
using ServiceAbstraction.Services;
using Infrastructure.Persistence.HttpClients;
using Infrastructure.Persistence.Data;
using Microsoft.EntityFrameworkCore;

namespace Service.Services;

public class WorkoutService : IWorkoutService
{
    private readonly MLServiceClient _mlClient;
    private readonly ApplicationDbContext _context;

    public WorkoutService(MLServiceClient mlClient, ApplicationDbContext context)
    {
        _mlClient = mlClient;
        _context = context;
    }

    public async Task<WorkoutPlan> GenerateWorkoutPlanAsync(Guid userId, string goal, string fitnessLevel, int durationWeeks)
    {
        var request = new { user_id = userId, goal, fitness_level = fitnessLevel, duration = durationWeeks };
        var response = await _mlClient.PostAsync<object>("/generate/workout", request);
        
        var plan = new WorkoutPlan
        {
            Id = Guid.NewGuid(),
            UserId = userId,
            Goal = goal,
            FitnessLevel = fitnessLevel,
            Duration = durationWeeks,
            GeneratedPlan = System.Text.Json.JsonSerializer.Serialize(response),
            CreatedAt = DateTime.UtcNow,
            IsActive = true
        };
        
        _context.WorkoutPlans.Add(plan);
        await _context.SaveChangesAsync();
        return plan;
    }

    public async Task<WorkoutPlan?> GetActiveWorkoutPlanAsync(Guid userId)
    {
        return await _context.WorkoutPlans
            .Where(w => w.UserId == userId && w.IsActive)
            .OrderByDescending(w => w.CreatedAt)
            .FirstOrDefaultAsync();
    }

    public async Task<IEnumerable<WorkoutPlan>> GetUserWorkoutHistoryAsync(Guid userId)
    {
        return await _context.WorkoutPlans
            .Where(w => w.UserId == userId)
            .OrderByDescending(w => w.CreatedAt)
            .ToListAsync();
    }
}
```

#### ✅ NutritionService.cs
```csharp
using DomainLayer.Models;
using ServiceAbstraction.Services;
using Infrastructure.Persistence.HttpClients;
using Infrastructure.Persistence.Data;
using Microsoft.EntityFrameworkCore;

namespace Service.Services;

public class NutritionService : INutritionService
{
    private readonly MLServiceClient _mlClient;
    private readonly ApplicationDbContext _context;

    public NutritionService(MLServiceClient mlClient, ApplicationDbContext context)
    {
        _mlClient = mlClient;
        _context = context;
    }

    public async Task<NutritionPlan> GenerateNutritionPlanAsync(Guid userId, string goal, int dailyCalories)
    {
        var request = new { user_id = userId, goal, daily_calories = dailyCalories };
        var response = await _mlClient.PostAsync<object>("/generate/nutrition", request);
        
        var plan = new NutritionPlan
        {
            Id = Guid.NewGuid(),
            UserId = userId,
            Goal = goal,
            DailyCalories = dailyCalories,
            Macros = "{}",
            GeneratedPlan = System.Text.Json.JsonSerializer.Serialize(response),
            CreatedAt = DateTime.UtcNow,
            IsActive = true
        };
        
        _context.NutritionPlans.Add(plan);
        await _context.SaveChangesAsync();
        return plan;
    }

    public async Task<NutritionPlan?> GetActiveNutritionPlanAsync(Guid userId)
    {
        return await _context.NutritionPlans
            .Where(n => n.UserId == userId && n.IsActive)
            .OrderByDescending(n => n.CreatedAt)
            .FirstOrDefaultAsync();
    }
}
```

#### ✅ CoachService.cs
```csharp
using DomainLayer.Models;
using ServiceAbstraction.Services;
using Infrastructure.Persistence.HttpClients;
using Infrastructure.Persistence.Data;
using Microsoft.EntityFrameworkCore;

namespace Service.Services;

public class CoachService : ICoachService
{
    private readonly MLServiceClient _mlClient;
    private readonly ApplicationDbContext _context;

    public CoachService(MLServiceClient mlClient, ApplicationDbContext context)
    {
        _mlClient = mlClient;
        _context = context;
    }

    public async Task<ChatMessage> SendMessageAsync(Guid userId, string message)
    {
        var request = new { user_id = userId, message };
        var response = await _mlClient.PostAsync<Dictionary<string, string>>("/coach/message", request);
        
        var chatMessage = new ChatMessage
        {
            Id = Guid.NewGuid(),
            UserId = userId,
            Message = message,
            Response = response["response"],
            IsFromUser = false,
            CreatedAt = DateTime.UtcNow
        };
        
        _context.ChatMessages.Add(chatMessage);
        await _context.SaveChangesAsync();
        return chatMessage;
    }

    public async Task<IEnumerable<ChatMessage>> GetConversationHistoryAsync(Guid userId, int limit = 50)
    {
        return await _context.ChatMessages
            .Where(c => c.UserId == userId)
            .OrderByDescending(c => c.CreatedAt)
            .Take(limit)
            .ToListAsync();
    }

    public async Task ScheduleReminderAsync(Guid userId, string reminderType, DateTime scheduledTime)
    {
        var reminder = new ProactiveReminder
        {
            Id = Guid.NewGuid(),
            UserId = userId,
            ReminderType = reminderType,
            Message = $"Reminder: {reminderType}",
            ScheduledTime = scheduledTime,
            IsSent = false,
            CreatedAt = DateTime.UtcNow
        };
        
        _context.ProactiveReminders.Add(reminder);
        await _context.SaveChangesAsync();
    }
}
```

#### ✅ AnalyticsService.cs
```csharp
using ServiceAbstraction.Services;
using Infrastructure.Persistence.HttpClients;

namespace Service.Services;

public class AnalyticsService : IAnalyticsService
{
    private readonly AnalyticsClient _analyticsClient;

    public AnalyticsService(AnalyticsClient analyticsClient)
    {
        _analyticsClient = analyticsClient;
    }

    public async Task<object> GetEquipmentUsageReportAsync(DateTime startDate, DateTime endDate)
    {
        return await _analyticsClient.GetAsync<object>(
            $"/analytics/usage?start={startDate:yyyy-MM-dd}&end={endDate:yyyy-MM-dd}");
    }

    public async Task<object> ForecastRevenueAsync(int days = 30)
    {
        return await _analyticsClient.GetAsync<object>($"/analytics/forecast?days={days}");
    }

    public async Task<object> PredictMaintenanceAsync(Guid equipmentId)
    {
        return await _analyticsClient.GetAsync<object>($"/analytics/maintenance/{equipmentId}");
    }
}
```

#### ✅ VoiceService.cs
```csharp
using DomainLayer.Models;
using ServiceAbstraction.Services;
using Infrastructure.Persistence.HttpClients;
using Infrastructure.Persistence.Data;

namespace Service.Services;

public class VoiceService : IVoiceService
{
    private readonly WhisperClient _whisperClient;
    private readonly TTSClient _ttsClient;
    private readonly ApplicationDbContext _context;

    public VoiceService(WhisperClient whisperClient, TTSClient ttsClient, ApplicationDbContext context)
    {
        _whisperClient = whisperClient;
        _ttsClient = ttsClient;
        _context = context;
    }

    public async Task<VoiceTranscription> TranscribeAudioAsync(Guid userId, Stream audioStream, string language = "en")
    {
        var response = await _whisperClient.TranscribeAsync(audioStream, language);
        
        var transcription = new VoiceTranscription
        {
            Id = Guid.NewGuid(),
            UserId = userId,
            TranscriptionText = response["text"],
            Language = language,
            CreatedAt = DateTime.UtcNow
        };
        
        _context.VoiceTranscriptions.Add(transcription);
        await _context.SaveChangesAsync();
        return transcription;
    }

    public async Task<byte[]> SynthesizeSpeechAsync(string text, string language = "en")
    {
        return await _ttsClient.SynthesizeAsync(text, language);
    }
}
```

---

## Phase 5: Infrastructure Layer (HTTP Clients)

### Infrastructure/Persistence/HttpClients/ (NEW FILES)

#### ✅ MLServiceClient.cs
```csharp
using System.Net.Http.Json;

namespace Infrastructure.Persistence.HttpClients;

public class MLServiceClient
{
    private readonly HttpClient _httpClient;
    private readonly string _baseUrl;

    public MLServiceClient(HttpClient httpClient, IConfiguration config)
    {
        _httpClient = httpClient;
        _baseUrl = config["MLServices:CoachServerUrl"] ?? "http://localhost:5002";
    }

    public async Task<T> PostAsync<T>(string endpoint, object data)
    {
        var response = await _httpClient.PostAsJsonAsync($"{_baseUrl}{endpoint}", data);
        response.EnsureSuccessStatusCode();
        return await response.Content.ReadFromJsonAsync<T>() ?? throw new Exception("Null response");
    }
}
```

#### ✅ AnalyticsClient.cs
```csharp
using System.Net.Http.Json;

namespace Infrastructure.Persistence.HttpClients;

public class AnalyticsClient
{
    private readonly HttpClient _httpClient;
    private readonly string _baseUrl;

    public AnalyticsClient(HttpClient httpClient, IConfiguration config)
    {
        _httpClient = httpClient;
        _baseUrl = config["MLServices:AnalyticsServerUrl"] ?? "http://localhost:5005";
    }

    public async Task<T> GetAsync<T>(string endpoint)
    {
        var response = await _httpClient.GetAsync($"{_baseUrl}{endpoint}");
        response.EnsureSuccessStatusCode();
        return await response.Content.ReadFromJsonAsync<T>() ?? throw new Exception("Null response");
    }
}
```

#### ✅ WhisperClient.cs
```csharp
namespace Infrastructure.Persistence.HttpClients;

public class WhisperClient
{
    private readonly HttpClient _httpClient;
    private readonly string _baseUrl;

    public WhisperClient(HttpClient httpClient, IConfiguration config)
    {
        _httpClient = httpClient;
        _baseUrl = config["MLServices:WhisperServerUrl"] ?? "http://localhost:5003";
    }

    public async Task<Dictionary<string, string>> TranscribeAsync(Stream audioStream, string language)
    {
        var content = new MultipartFormDataContent();
        content.Add(new StreamContent(audioStream), "audio", "audio.wav");
        content.Add(new StringContent(language), "language");
        
        var response = await _httpClient.PostAsync($"{_baseUrl}/transcribe", content);
        response.EnsureSuccessStatusCode();
        return await response.Content.ReadFromJsonAsync<Dictionary<string, string>>() ?? new();
    }
}
```

#### ✅ TTSClient.cs
```csharp
namespace Infrastructure.Persistence.HttpClients;

public class TTSClient
{
    private readonly HttpClient _httpClient;
    private readonly string _baseUrl;

    public TTSClient(HttpClient httpClient, IConfiguration config)
    {
        _httpClient = httpClient;
        _baseUrl = config["MLServices:TTSServerUrl"] ?? "http://localhost:5004";
    }

    public async Task<byte[]> SynthesizeAsync(string text, string language)
    {
        var request = new { text, language };
        var response = await _httpClient.PostAsJsonAsync($"{_baseUrl}/synthesize", request);
        response.EnsureSuccessStatusCode();
        return await response.Content.ReadAsByteArrayAsync();
    }
}
```

---

## Phase 6: Controllers (NEW FILES)

### Graduation-Project/Controllers/ (NEW FILES)

#### ✅ WorkoutController.cs
```csharp
using Microsoft.AspNetCore.Mvc;
using ServiceAbstraction.Services;

namespace Graduation_Project.Controllers;

[ApiController]
[Route("api/[controller]")]
public class WorkoutController : ControllerBase
{
    private readonly IWorkoutService _workoutService;

    public WorkoutController(IWorkoutService workoutService)
    {
        _workoutService = workoutService;
    }

    [HttpPost("generate")]
    public async Task<IActionResult> GenerateWorkoutPlan(
        [FromBody] GenerateWorkoutRequest request)
    {
        var plan = await _workoutService.GenerateWorkoutPlanAsync(
            request.UserId, request.Goal, request.FitnessLevel, request.DurationWeeks);
        return Ok(plan);
    }

    [HttpGet("active/{userId}")]
    public async Task<IActionResult> GetActivePlan(Guid userId)
    {
        var plan = await _workoutService.GetActiveWorkoutPlanAsync(userId);
        return plan != null ? Ok(plan) : NotFound();
    }
}

public record GenerateWorkoutRequest(Guid UserId, string Goal, string FitnessLevel, int DurationWeeks);
```

#### ✅ NutritionController.cs
```csharp
using Microsoft.AspNetCore.Mvc;
using ServiceAbstraction.Services;

namespace Graduation_Project.Controllers;

[ApiController]
[Route("api/[controller]")]
public class NutritionController : ControllerBase
{
    private readonly INutritionService _nutritionService;

    public NutritionController(INutritionService nutritionService)
    {
        _nutritionService = nutritionService;
    }

    [HttpPost("generate")]
    public async Task<IActionResult> GenerateNutritionPlan(
        [FromBody] GenerateNutritionRequest request)
    {
        var plan = await _nutritionService.GenerateNutritionPlanAsync(
            request.UserId, request.Goal, request.DailyCalories);
        return Ok(plan);
    }

    [HttpGet("active/{userId}")]
    public async Task<IActionResult> GetActivePlan(Guid userId)
    {
        var plan = await _nutritionService.GetActiveNutritionPlanAsync(userId);
        return plan != null ? Ok(plan) : NotFound();
    }
}

public record GenerateNutritionRequest(Guid UserId, string Goal, int DailyCalories);
```

#### ✅ CoachController.cs
```csharp
using Microsoft.AspNetCore.Mvc;
using ServiceAbstraction.Services;

namespace Graduation_Project.Controllers;

[ApiController]
[Route("api/[controller]")]
public class CoachController : ControllerBase
{
    private readonly ICoachService _coachService;

    public CoachController(ICoachService coachService)
    {
        _coachService = coachService;
    }

    [HttpPost("message")]
    public async Task<IActionResult> SendMessage([FromBody] SendMessageRequest request)
    {
        var response = await _coachService.SendMessageAsync(request.UserId, request.Message);
        return Ok(response);
    }

    [HttpGet("history/{userId}")]
    public async Task<IActionResult> GetHistory(Guid userId, [FromQuery] int limit = 50)
    {
        var history = await _coachService.GetConversationHistoryAsync(userId, limit);
        return Ok(history);
    }

    [HttpPost("reminder")]
    public async Task<IActionResult> ScheduleReminder([FromBody] ScheduleReminderRequest request)
    {
        await _coachService.ScheduleReminderAsync(request.UserId, request.ReminderType, request.ScheduledTime);
        return Ok();
    }
}

public record SendMessageRequest(Guid UserId, string Message);
public record ScheduleReminderRequest(Guid UserId, string ReminderType, DateTime ScheduledTime);
```

#### ✅ AnalyticsController.cs
```csharp
using Microsoft.AspNetCore.Mvc;
using ServiceAbstraction.Services;

namespace Graduation_Project.Controllers;

[ApiController]
[Route("api/[controller]")]
public class AnalyticsController : ControllerBase
{
    private readonly IAnalyticsService _analyticsService;

    public AnalyticsController(IAnalyticsService analyticsService)
    {
        _analyticsService = analyticsService;
    }

    [HttpGet("usage")]
    public async Task<IActionResult> GetUsageReport([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
    {
        var report = await _analyticsService.GetEquipmentUsageReportAsync(startDate, endDate);
        return Ok(report);
    }

    [HttpGet("forecast")]
    public async Task<IActionResult> ForecastRevenue([FromQuery] int days = 30)
    {
        var forecast = await _analyticsService.ForecastRevenueAsync(days);
        return Ok(forecast);
    }

    [HttpGet("maintenance/{equipmentId}")]
    public async Task<IActionResult> PredictMaintenance(Guid equipmentId)
    {
        var prediction = await _analyticsService.PredictMaintenanceAsync(equipmentId);
        return Ok(prediction);
    }
}
```

#### ✅ VoiceController.cs
```csharp
using Microsoft.AspNetCore.Mvc;
using ServiceAbstraction.Services;

namespace Graduation_Project.Controllers;

[ApiController]
[Route("api/[controller]")]
public class VoiceController : ControllerBase
{
    private readonly IVoiceService _voiceService;

    public VoiceController(IVoiceService voiceService)
    {
        _voiceService = voiceService;
    }

    [HttpPost("transcribe")]
    public async Task<IActionResult> TranscribeAudio([FromForm] IFormFile audio, [FromQuery] string language = "en")
    {
        using var stream = audio.OpenReadStream();
        var transcription = await _voiceService.TranscribeAudioAsync(Guid.NewGuid(), stream, language);
        return Ok(transcription);
    }

    [HttpPost("synthesize")]
    public async Task<IActionResult> SynthesizeSpeech([FromBody] SynthesizeSpeechRequest request)
    {
        var audioBytes = await _voiceService.SynthesizeSpeechAsync(request.Text, request.Language);
        return File(audioBytes, "audio/wav", "speech.wav");
    }
}

public record SynthesizeSpeechRequest(string Text, string Language = "en");
```

---

## Phase 7: Update DbContext

### Infrastructure/Persistence/Data/ApplicationDbContext.cs (UPDATE)

Add these DbSets:

```csharp
public DbSet<ChatMessage> ChatMessages { get; set; }
public DbSet<WorkoutPlan> WorkoutPlans { get; set; }
public DbSet<NutritionPlan> NutritionPlans { get; set; }
public DbSet<EquipmentUsage> EquipmentUsage { get; set; }
public DbSet<ProactiveReminder> ProactiveReminders { get; set; }
public DbSet<VoiceTranscription> VoiceTranscriptions { get; set; }
```

---

## Phase 8: Update Program.cs (Dependency Injection)

### Graduation-Project/Program.cs (UPDATE)

```csharp
// HTTP Clients
builder.Services.AddHttpClient<MLServiceClient>();
builder.Services.AddHttpClient<AnalyticsClient>();
builder.Services.AddHttpClient<WhisperClient>();
builder.Services.AddHttpClient<TTSClient>();

// Services
builder.Services.AddScoped<IWorkoutService, WorkoutService>();
builder.Services.AddScoped<INutritionService, NutritionService>();
builder.Services.AddScoped<ICoachService, CoachService>();
builder.Services.AddScoped<IAnalyticsService, AnalyticsService>();
builder.Services.AddScoped<IVoiceService, VoiceService>();
```

---

## Phase 9: Update appsettings.json

### Graduation-Project/appsettings.json (UPDATE)

```json
{
  "MLServices": {
    "CoachServerUrl": "http://localhost:5002",
    "AnalyticsServerUrl": "http://localhost:5005",
    "WhisperServerUrl": "http://localhost:5003",
    "TTSServerUrl": "http://localhost:5004",
    "EmbeddingServerUrl": "http://localhost:5100"
  }
}
```

---

## Phase 10: Python Microservices (Already Exist - Just Add Routes)

### ml_models/coach_server/app.py (UPDATE - Add Routes)

```python
@app.route('/generate/workout', methods=['POST'])
def generate_workout():
    data = request.get_json()
    user_id = data['user_id']
    goal = data['goal']
    fitness_level = data['fitness_level']
    duration = data['duration']
    
    context = retrieve_context(f"workout plan {goal} {fitness_level}")
    prompt = f"Generate {duration}-week {goal} workout for {fitness_level} level"
    # TODO: Use LLM or template-based generation
    
    return jsonify({
        'plan': {
            'weeks': duration,
            'exercises': []  # TODO: Generate real exercises
        }
    })

@app.route('/generate/nutrition', methods=['POST'])
def generate_nutrition():
    data = request.get_json()
    user_id = data['user_id']
    goal = data['goal']
    daily_calories = data['daily_calories']
    
    context = retrieve_context(f"nutrition plan {goal}")
    # TODO: Generate meal plan
    
    return jsonify({
        'meals': [],
        'daily_calories': daily_calories
    })

@app.route('/coach/message', methods=['POST'])
def coach_message():
    data = request.get_json()
    message = data['message']
    
    context = retrieve_context(message)
    # TODO: Use LLM to generate response
    response_text = f"I understand you're asking about: {message}"
    
    return jsonify({'response': response_text})
```

---

## Summary Checklist

### Database ✅
- [ ] Create migration for 6 new tables
- [ ] Run `dotnet ef migrations add AddMLTables`
- [ ] Run `dotnet ef database update`

### .NET Domain (6 new files)
- [ ] WorkoutPlan.cs
- [ ] NutritionPlan.cs
- [ ] ChatMessage.cs
- [ ] EquipmentUsage.cs
- [ ] ProactiveReminder.cs
- [ ] VoiceTranscription.cs

### .NET Interfaces (5 new files)
- [ ] IWorkoutService.cs
- [ ] INutritionService.cs
- [ ] ICoachService.cs
- [ ] IAnalyticsService.cs
- [ ] IVoiceService.cs

### .NET Services (5 new files)
- [ ] WorkoutService.cs
- [ ] NutritionService.cs
- [ ] CoachService.cs
- [ ] AnalyticsService.cs
- [ ] VoiceService.cs

### .NET HTTP Clients (4 new files)
- [ ] MLServiceClient.cs
- [ ] AnalyticsClient.cs
- [ ] WhisperClient.cs
- [ ] TTSClient.cs

### .NET Controllers (5 new files)
- [ ] WorkoutController.cs
- [ ] NutritionController.cs
- [ ] CoachController.cs
- [ ] AnalyticsController.cs
- [ ] VoiceController.cs

### Configuration Updates
- [ ] Update ApplicationDbContext.cs (add 6 DbSets)
- [ ] Update Program.cs (register services)
- [ ] Update appsettings.json (ML service URLs)

### Python Services
- [ ] Add 3 routes to coach_server/app.py
- [ ] Ensure analytics_server/app.py runs
- [ ] Ensure whisper_server/app.py exists
- [ ] Ensure tts_server/app.py exists

**Total: 25 new .NET files + 6 tables + 4 Python services**
